var __reflect=this&&this.__reflect||function(t,e,a){t.__class__=e,a?a.push(e):a=[e],t.__types__=t.__types__?a.concat(t.__types__):a},__extends=this&&this.__extends||function(t,e){function a(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(a.prototype=e.prototype,new a)},DragManager=function(){function t(){this.dragTarget=null,this._isDragMove=!1,this._helpPoint=new egret.Point,this._dragPosition=new egret.Point,this._dragOffset=new egret.Point,this._dragSpeed=new egret.Point}return t.getInstance=function(){return t._instance||(t._instance=new t),t._instance},t.prototype.enableDrag=function(t){t&&(t.touchEnabled=!0,t.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this._dragHandler,this),t.addEventListener(egret.TouchEvent.TOUCH_RELEASE_OUTSIDE,this._dragHandler,this),t.addEventListener(egret.TouchEvent.TOUCH_END,this._dragHandler,this))},t.prototype.disableDrag=function(t){t&&(t.removeEventListener(egret.TouchEvent.TOUCH_BEGIN,this._dragHandler,this),t.removeEventListener(egret.TouchEvent.TOUCH_RELEASE_OUTSIDE,this._dragHandler,this),t.removeEventListener(egret.TouchEvent.TOUCH_END,this._dragHandler,this),t.removeEventListener(egret.Event.ENTER_FRAME,this._enterFrameHandler,this))},t.prototype._dragHandler=function(e){switch(e.type){case egret.TouchEvent.TOUCH_BEGIN:if(this.dragTarget)return;this.dragTarget=e.currentTarget,this.dragTarget.parent.globalToLocal(e.stageX,e.stageY,this._helpPoint),this._dragPosition.x=this.dragTarget.x,this._dragPosition.y=this.dragTarget.y,this._dragOffset.x=this._dragPosition.x-this._helpPoint.x,this._dragOffset.y=this._dragPosition.y-this._helpPoint.y,this._dragSpeed.x=0,this._dragSpeed.y=0,this.dragTarget.stage.addEventListener(egret.TouchEvent.TOUCH_MOVE,this._dragHandler,this);break;case egret.TouchEvent.TOUCH_RELEASE_OUTSIDE:case egret.TouchEvent.TOUCH_END:this.dragTarget&&(this.dragTarget.stage.removeEventListener(egret.TouchEvent.TOUCH_MOVE,this._dragHandler,this),this._isDragMove?this.dragTarget.dragSpeed=this._dragSpeed.clone():this.dragTarget.removeEventListener(egret.Event.ENTER_FRAME,this._enterFrameHandler,this),this.dragTarget.dispatchEventWith(t.DRAG_END),this.dragTarget=null),this._isDragMove=!1;break;case egret.TouchEvent.TOUCH_MOVE:if(this.dragTarget){this.dragTarget.parent.globalToLocal(e.stageX,e.stageY,this._helpPoint);var a=this._helpPoint.x+this._dragOffset.x,n=this._helpPoint.y+this._dragOffset.y;!this._isDragMove&&(Math.abs(this._dragPosition.x-a)>5||Math.abs(this._dragPosition.y-n)>5)&&(this._isDragMove=!0,this.dragTarget.dispatchEventWith(t.DRAG_BEGIN),this.dragTarget.addEventListener(egret.Event.ENTER_FRAME,this._enterFrameHandler,this)),this._isDragMove&&(this.dragTarget.parent.globalToLocal(e.stageX,e.stageY,this._helpPoint),this._dragPosition.x=a,this._dragPosition.y=n)}}},t.prototype._enterFrameHandler=function(e){var a=e.currentTarget;if(a===this.dragTarget)this._dragSpeed.x+=.5*(this._dragPosition.x-a.x-this._dragSpeed.x),this._dragSpeed.y+=.5*(this._dragPosition.y-a.y-this._dragSpeed.y),(a.x!==this._dragPosition.x||a.y!==this._dragPosition.y)&&(a.x=this._dragPosition.x,a.y=this._dragPosition.y,a.hasEventListener(t.DRAG_MOVE)&&a.dispatchEventWith(t.DRAG_MOVE));else{var n=a.dragSpeed;a.x+=n.x,a.y+=n.y,n.x*=.7,n.y*=.7,a.hasEventListener(t.DRAG_MOVE)&&a.dispatchEventWith(t.DRAG_MOVE),Math.abs(n.x)<1&&Math.abs(n.y)<1&&a.removeEventListener(egret.Event.ENTER_FRAME,this._enterFrameHandler,this)}},t}();DragManager.DRAG_BEGIN="dragBegin",DragManager.DRAG_END="dragEnd",DragManager.DRAG_MOVE="dragMove",DragManager._instance=null,__reflect(DragManager.prototype,"DragManager");var Main=function(t){function e(){var a=t.call(this)||this;return a.context=new egret.EventDispatcher,a.model=new DragonBonesModel,a.view=new DragonBonesView,e._instance=a,a.addChild(a.view),a.addEventListener(egret.Event.ADDED_TO_STAGE,a._addToStageHandler,a),a}return __extends(e,t),e.getInstance=function(){return e._instance},e.prototype._addToStageHandler=function(t){this._init()},e.prototype._init=function(){var t=this;this.model.init(),this.view.init(),console.assert(null!=document);var a=document.getElementById(e.DATA);if(a&&(this.model.inputData=JSON.parse(a.innerHTML),this._changeArmatureAndAnimation(),void 0!==this.model.inputData.config)){this.view.gridEnabled=this.model.inputData.config.gridEnabled;var n=document.getElementById("dragonbones-player");console.assert(null!==n),n.style.backgroundColor=this.model.inputData.config.backgroundColor}if(!egret.Capabilities.isMobile){var i=document.body;i.ondragenter=i.ondragover=function(t){t.stopPropagation(),t.preventDefault()},i.ondrop=function(e){e.stopPropagation(),e.preventDefault();var a=e.dataTransfer;a&&a.files&&t._loadFiles(a.files)}}var r=new SkinView;r.init()},e.prototype._changeArmatureAndAnimation=function(){if(this.model.inputData&&this.model.dragonBonesData){var t=this.model.inputData.armature;t&&this.model.dragonBonesData.armatureNames.indexOf(t)>=0?this.model.armature=this.model.addArmature(this.model.inputData.armature):this.model.armature=this.model.addArmature(this.model.dragonBonesData.armatureNames[0]),this.model.armature&&(this.model.inputData.animation?this.model.armature.animation.play(this.model.inputData.animation):this.model.armature.animation.play())}},e.prototype._loadFiles=function(t){for(var e=this,a=[],n=(function(n){var i=n.target,r=i.file;if("image/png"===r.type?a.push(i):a.unshift(i),a.length===t.length){var o={textureAtlases:[],textures:[]},s=0;a.forEach(function(t){var e=t.file;if("image/png"===e.type){var a=document.createElement("img");a.id="textureAtlas_"+ ++s,a.src=t.result;var n=document.getElementById("hide"),i=document.getElementById(a.id);i&&(i.id="",i.src="",n.removeChild(i)),n.appendChild(a)}else try{var r=JSON.parse(t.result);"armature"in r?o.data||(o.data=r):(o.textureAtlases.push(r),o.textures.push("textureAtlas_"+(o.textures.length+1)))}catch(d){}}),e.model.inputData=o,e._changeArmatureAndAnimation()}}),i=0,r=t.length;r>i;++i){var o=t[i];if("image/png"===o.type){var s=new FileReader;s.file=o,s.onload=n,s.readAsDataURL(o)}else if(o.name.indexOf(".json")>0){var s=new FileReader;s.file=o,s.onload=n,s.readAsBinaryString(o)}}},e}(egret.DisplayObjectContainer);Main.DATA="data",Main._instance=null,__reflect(Main.prototype,"Main");var ModelEvent;!function(t){t[t.DragonBonesChange=100]="DragonBonesChange",t[t.ArmatureAdd=101]="ArmatureAdd",t[t.ArmatureRemove=102]="ArmatureRemove",t[t.ArmatureChange=103]="ArmatureChange",t[t.AnimationStart=104]="AnimationStart",t[t.AnimationComplete=105]="AnimationComplete",t[t.AnimationPlay=106]="AnimationPlay",t[t.AnimationStop=107]="AnimationStop",t[t.AnimationChange=108]="AnimationChange"}(ModelEvent||(ModelEvent={}));var DragonBonesModel=function(){function t(){this._armatures=[],this._inputData=null,this._dragonBonesData=null,this._armature=null,this._animation=null}return t.prototype._animationHandler=function(t){switch(t.type){case dragonBones.EventObject.FADE_IN:this._animation&&this._animation.name===t.animationState.name||(this._animation=t.animationState,Main.getInstance().context.dispatchEventWith(ModelEvent[ModelEvent.AnimationChange],!1,this._animation)),Main.getInstance().context.dispatchEventWith(ModelEvent[ModelEvent.AnimationStart],!1,this._animation);break;case dragonBones.EventObject.COMPLETE:Main.getInstance().context.dispatchEventWith(ModelEvent[ModelEvent.AnimationComplete],!1,this._animation)}},t.prototype.init=function(){},t.prototype.addArmature=function(t){if(!t)return null;var e=dragonBones.EgretFactory.factory.buildArmatureDisplay(t);return console.assert(null!=e),this._armatures.push(e.armature),Main.getInstance().context.dispatchEventWith(ModelEvent[ModelEvent.ArmatureAdd],!1,e.armature),e.armature},t.prototype.removeArmature=function(t){var e=this._armatures.indexOf(t);console.assert(e>=0),this.armature=null,this._armatures.splice(e,1),Main.getInstance().context.dispatchEventWith(ModelEvent[ModelEvent.ArmatureRemove],!1,t),t.dispose()},t.prototype.clearAllArmature=function(){for(var t=this._armatures.length;t--;){var e=this._armatures[t];this.removeArmature(e)}},t.prototype.changeArmature=function(t){if(this._armature){var e=this._dragonBonesData.armatureNames;t%=e.length,0>t&&(t=e.length+t),this.removeArmature(this._armature),this.armature=this.addArmature(e[t]),this.armature.animation.play()}},t.prototype.prevArmature=function(){this._armature?this.changeArmature(this._dragonBonesData.armatureNames.indexOf(this._armature.name)-1):this.changeArmature(0)},t.prototype.nextArmature=function(){this._armature?this.changeArmature(this._dragonBonesData.armatureNames.indexOf(this._armature.name)+1):this.changeArmature(0)},t.prototype.changeAnimation=function(t){if(this._armature){var e=this._armature.armatureData.animationNames;t%=e.length,0>t&&(t=e.length+t),this._armature.animation.fadeIn(e[t])}},t.prototype.prevAnimation=function(){if(this._armature)if(this._animation){var t=this._armature.armatureData.animationNames;this.changeAnimation(t.indexOf(this._animation.name)-1)}else this._armature.animation.play()},t.prototype.nextAnimation=function(){if(this._armature)if(this._animation){var t=this._armature.armatureData.animationNames;this.changeAnimation(t.indexOf(this._animation.name)+1)}else this._armature.animation.play()},t.prototype.playAnimation=function(){this._armature&&(this._armature.animation.lastAnimationState.isCompleted?this._armature.animation.play():this._armature.animation.lastAnimationState.play(),Main.getInstance().context.dispatchEventWith(ModelEvent[ModelEvent.AnimationPlay],!1))},t.prototype.stopAnimation=function(){this._armature&&(this._armature.animation.lastAnimationState.stop(),Main.getInstance().context.dispatchEventWith(ModelEvent[ModelEvent.AnimationStop],!1))},Object.defineProperty(t.prototype,"inputData",{get:function(){return this._inputData},set:function(t){if(this._inputData!==t){if(this.clearAllArmature(),this._inputData=t,this._inputData){console.assert(null!=this._inputData.data),console.assert(null!=this._inputData.textureAtlases),console.assert(null!=this._inputData.textures);var e=[];this._inputData.textures.forEach(function(t){if(t instanceof egret.Texture)e.push(t);else{var a=new egret.Texture,n=document.getElementById(t);console.assert(null!=n),a.bitmapData=new egret.BitmapData(n),e.push(a)}}),dragonBones.EgretFactory.factory.clear(!0),this._dragonBonesData=dragonBones.EgretFactory.factory.parseDragonBonesData(this._inputData.data),this._inputData.textureAtlases.forEach(function(t,a){dragonBones.EgretFactory.factory.parseTextureAtlasData(t,e[a])})}Main.getInstance().context.dispatchEventWith(ModelEvent[ModelEvent.DragonBonesChange],!1,this._inputData)}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dragonBonesData",{get:function(){return this._dragonBonesData},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"armatures",{get:function(){return this._armatures},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"armature",{get:function(){return this._armature},set:function(t){this._armature!==t&&(this._animation=null,Main.getInstance().context.dispatchEventWith(ModelEvent[ModelEvent.AnimationChange],!1,null),this._armature&&(this._armature.removeEventListener(dragonBones.EventObject.FADE_IN,this._animationHandler,this),this._armature.removeEventListener(dragonBones.EventObject.COMPLETE,this._animationHandler,this)),this._armature=t,this._armature&&(this._armature.addEventListener(dragonBones.EventObject.FADE_IN,this._animationHandler,this),this._armature.addEventListener(dragonBones.EventObject.COMPLETE,this._animationHandler,this)),Main.getInstance().context.dispatchEventWith(ModelEvent[ModelEvent.ArmatureChange],!1,this._armature))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"animation",{get:function(){return this._animation},enumerable:!0,configurable:!0}),t}();__reflect(DragonBonesModel.prototype,"DragonBonesModel");var SkinView=function(){function t(){this._speeds=[.1,.25,.5,1,1.5,2,4,8],this._armatureList=null,this._animationList=null,this._armatureNameLabel=null,this._animationNameLabel=null,this._animationSpeedLabel=null,this._prevArmatureButton=null,this._nextArmatureButton=null,this._prevAnimationButton=null,this._nextAnimationButton=null,this._stopAnimationButton=null,this._playAnimationButton=null,this._reduceAnimationSpeedButton=null,this._addAnimationSpeedButton=null,this._gridEnabledButton=null,this._debugEnabledButton=null}return t.prototype._modelEventHandler=function(t){switch(t.type){case ModelEvent[ModelEvent.DragonBonesChange]:this._updateArmatureList(!0);break;case ModelEvent[ModelEvent.ArmatureChange]:this._updateArmatureList(!1),this._updateAnimationList(!0),this._updateAnimationSpeedLabel(),this._updateArmatureAndAnimationInfo();break;case ModelEvent[ModelEvent.AnimationChange]:this._updateAnimationList(!1),this._updateArmatureAndAnimationInfo();break;case ModelEvent[ModelEvent.AnimationStart]:case ModelEvent[ModelEvent.AnimationComplete]:case ModelEvent[ModelEvent.AnimationPlay]:case ModelEvent[ModelEvent.AnimationStop]:this._updatePlayAndStopButton()}},t.prototype._updateArmatureList=function(t){if(this._armatureList)if(this._model.inputData){var e=this._model.dragonBonesData.armatureNames;if(t){this._armatureList.innerHTML="";for(var a=0,n=e;a<n.length;a++){var i=n[a],r=document.createElement("option");r.innerHTML=i,this._armatureList.appendChild(r)}}else this._model.armature?this._armatureList.selectedIndex=e.indexOf(this._model.armature.name):this._armatureList.selectedIndex=-1}else this._armatureList.innerHTML=""},t.prototype._updateAnimationList=function(t){if(this._animationList)if(this._model.armature){var e=this._model.armature.animation.animationNames;if(t){this._animationList.innerHTML="";for(var a=0,n=e;a<n.length;a++){var i=n[a],r=document.createElement("option");r.innerHTML=i,this._animationList.appendChild(r)}}else this._model.animation?this._animationList.selectedIndex=e.indexOf(this._model.animation.name):this._animationList.selectedIndex=-1}else this._animationList.innerHTML=""},t.prototype._updatePlayAndStopButton=function(){this._model.armature&&this._model.armature.animation.isPlaying?(this._stopAnimationButton.style.display="none",this._playAnimationButton.style.display="block"):(this._stopAnimationButton.style.display="block",this._playAnimationButton.style.display="none")},t.prototype._updateAnimationSpeedLabel=function(){this._model.armature&&this._animationSpeedLabel&&(this._animationSpeedLabel.innerHTML="X "+this._model.armature.animation.timeScale.toFixed(2))},t.prototype._updateGridEnabled=function(){this._gridEnabledButton&&(Main.getInstance().view.gridEnabled?this._gridEnabledButton.className="db_open":this._gridEnabledButton.className="db_close")},t.prototype._updateDebugEnabled=function(){this._debugEnabledButton&&(dragonBones.DragonBones.debugDraw?this._debugEnabledButton.className="db_open":this._debugEnabledButton.className="db_close")},t.prototype._updateArmatureAndAnimationInfo=function(){var t=this._model.dragonBonesData,e=this._model.armature,a=this._model.animation;if(t&&e&&a){var n=document.getElementById("infoLabel");return void(n&&(n.innerHTML=lang.get(lang.Label.infoLabel,e.armatureData.animationNames.length,e.armatureData.sortedBones.length,e.armatureData.sortedSlots.length)))}this._updateElementLanguage(lang.None,"infoLabel")},t.prototype._updateElementLanguage=function(t,e){var a=document.getElementById(e);a&&(a.innerHTML=lang.get(t))},t.prototype.init=function(){var t=this;this._model=Main.getInstance().model,lang.setLanguageByString(navigator.language),this._armatureList=document.getElementById("armatureList"),this._animationList=document.getElementById("animationList"),this._armatureNameLabel=document.getElementById("armatureNameLabel"),this._animationNameLabel=document.getElementById("animationNameLabel"),this._animationSpeedLabel=document.getElementById("animationSpeedLabel"),this._prevArmatureButton=document.getElementById("prevArmatureButton"),this._nextArmatureButton=document.getElementById("nextArmatureButton"),this._prevAnimationButton=document.getElementById("prevAnimationButton"),this._nextAnimationButton=document.getElementById("nextAnimationButton"),this._stopAnimationButton=document.getElementById("playAnimationButton"),this._playAnimationButton=document.getElementById("stopAnimationButton"),this._reduceAnimationSpeedButton=document.getElementById("reduceAnimationSpeedButton"),this._addAnimationSpeedButton=document.getElementById("addAnimationSpeedButton"),this._gridEnabledButton=document.getElementById("gridEnabledButton"),this._debugEnabledButton=document.getElementById("debugEnabledButton"),this._updateArmatureList(!0),this._updateArmatureList(!1),this._updateAnimationList(!0),this._updateAnimationList(!1),this._updatePlayAndStopButton(),this._updateAnimationSpeedLabel(),this._updateGridEnabled(),this._updateElementLanguage(lang.Label.armatureTitleLabel,"armatureTitleLabel"),this._updateElementLanguage(lang.Label.animationTitleLabel,"animationTitleLabel"),this._updateElementLanguage(lang.Label.animationControlLabel,"animationControlLabel"),this._updateElementLanguage(lang.Label.backgroundColorLabel,"backgroundColorLabel"),this._updateElementLanguage(lang.Label.gridLabel,"gridLabel"),this._updateElementLanguage(lang.Label.debugLabel,"debugLabel"),this._updateElementLanguage(lang.Label.qrcodeLabel,"qrcodeLabel"),this._model.armature?this._updateArmatureAndAnimationInfo():this._updateElementLanguage(lang.None,"infoLabel"),egret.Capabilities.isMobile?document.getElementById("qrcodeGroup").style.display="none":0===window.location.protocol.indexOf("http")?new QRCode(document.getElementById("qrcode"),{width:96,height:96}).makeCode(window.location.href):document.getElementById("qrcodeGroup").style.display="none",this._armatureList&&(this._armatureList.onchange=function(e){t._model.changeArmature(t._armatureList.selectedIndex)}),this._animationList&&(this._animationList.onchange=function(e){t._model.changeAnimation(t._animationList.selectedIndex)}),this._prevArmatureButton&&(this._prevArmatureButton.onclick=function(){t._model.prevArmature()}),this._nextArmatureButton&&(this._nextArmatureButton.onclick=function(){t._model.nextArmature()}),this._prevAnimationButton&&(this._prevAnimationButton.onclick=function(){t._model.stopAnimation(),t._model.armature&&(t._model.armature.animation.lastAnimationState.currentTime-=1/t._model.armature.armatureData.frameRate)}),this._nextAnimationButton&&(this._nextAnimationButton.onclick=function(){t._model.stopAnimation(),t._model.armature&&(t._model.armature.animation.lastAnimationState.currentTime+=1/t._model.armature.armatureData.frameRate)}),this._stopAnimationButton&&(this._stopAnimationButton.onclick=function(){t._model.playAnimation()}),this._playAnimationButton&&(this._playAnimationButton.onclick=function(){t._model.stopAnimation()}),this._reduceAnimationSpeedButton&&(this._reduceAnimationSpeedButton.onclick=function(){if(t._model.armature){var e=t._speeds.indexOf(t._model.armature.animation.timeScale)-1;0>e&&(e=0),t._model.armature.animation.timeScale=t._speeds[e],t._updateAnimationSpeedLabel()}}),this._addAnimationSpeedButton&&(this._addAnimationSpeedButton.onclick=function(){if(t._model.armature){var e=t._speeds.indexOf(t._model.armature.animation.timeScale)+1;e>=t._speeds.length&&(e=t._speeds.length-1),t._model.armature.animation.timeScale=t._speeds[e],t._updateAnimationSpeedLabel()}}),this._gridEnabledButton&&(this._gridEnabledButton.onclick=function(){Main.getInstance().view.gridEnabled=!Main.getInstance().view.gridEnabled,t._updateGridEnabled()}),this._debugEnabledButton&&(this._debugEnabledButton.onclick=function(){dragonBones.DragonBones.debugDraw=!dragonBones.DragonBones.debugDraw,t._updateDebugEnabled()}),Main.getInstance().context.addEventListener(ModelEvent[ModelEvent.DragonBonesChange],this._modelEventHandler,this),Main.getInstance().context.addEventListener(ModelEvent[ModelEvent.ArmatureChange],this._modelEventHandler,this),Main.getInstance().context.addEventListener(ModelEvent[ModelEvent.AnimationChange],this._modelEventHandler,this),Main.getInstance().context.addEventListener(ModelEvent[ModelEvent.AnimationStart],this._modelEventHandler,this),Main.getInstance().context.addEventListener(ModelEvent[ModelEvent.AnimationComplete],this._modelEventHandler,this),Main.getInstance().context.addEventListener(ModelEvent[ModelEvent.AnimationPlay],this._modelEventHandler,this),Main.getInstance().context.addEventListener(ModelEvent[ModelEvent.AnimationStop],this._modelEventHandler,this)},t}();__reflect(SkinView.prototype,"SkinView");var lang;!function(t){function e(e){switch(e.toLowerCase()){case"en-us":t.language=n.en_US;break;case"zh-cn":t.language=n.zh_CN;break;case"ru-fr":t.language=n.ru_RF;break;default:t.language=n.en_US}}function a(e){for(var a=[],i=1;i<arguments.length;i++)a[i-1]=arguments[i];var r;if(e instanceof Array&&(r=t.language<e.length?e[t.language]:e[n.en_US]),a.length>0)for(var o=0,s=a.length;s>o;++o)r=r.replace("{"+o+"}",a[o]);return r}var n;!function(t){t[t.en_US=0]="en_US",t[t.zh_CN=1]="zh_CN",t[t.ru_RF=2]="ru_RF"}(n=t.LanguageType||(t.LanguageType={})),t.language=n.en_US,t.setLanguageByString=e,t.get=a,t.None=["","",""],t.Label={armatureTitleLabel:["Armature","骨架","Armature"],animationTitleLabel:["Animation","动画","Animation"],animationControlLabel:["Animation Control","动画控制","Animation Control"],backgroundColorLabel:["Background Color","背景色","Background Color"],gridLabel:["Show Grid","显示网格","Show Grid"],debugLabel:["Show Bone","显示骨骼","Show Bone"],infoLabel:["Infomation<br/>Animation {0}<br/>Bone {1}<br/>Slot {2}<br/>","信息<br/>动画 {0}<br/>骨骼 {1}<br/>插槽 {2}<br/>","Infomation<br/>Animation {0}<br/>Bone {1}<br/>Slot {2}<br/>"],qrcodeLabel:["QrCode","扫描二维码，在手机端查看","QrCode"]}}(lang||(lang={}));var DragonBonesView=function(t){function e(){var e=t.call(this)||this;return e._gridEnabled=!0,e._isDraged=!1,e._scaleType=3,e._stageWidth=0,e._stageHeight=0,e._stageScale=1,e._gridScale=2,e._time=0,e._timer=-1,e._stageScalePoint=new egret.Point,e._viewStage=new egret.DisplayObjectContainer,e._armatureContainer=new egret.DisplayObjectContainer,e._lineH=new egret.Shape,e._lineV=new egret.Shape,e._grid=new egret.Bitmap,e._viewStage.addChild(e._grid),e._viewStage.addChild(e._lineV),e._viewStage.addChild(e._lineH),e._viewStage.addChild(e._armatureContainer),e._lineH.graphics.lineStyle(1,0,1,!0),e._lineV.graphics.lineStyle(1,0,1,!0),e._lineH.graphics.moveTo(0,0),e._lineV.graphics.moveTo(0,0),e._lineH.graphics.lineTo(101,0),e._lineV.graphics.lineTo(0,101),e._grid.visible=e._gridEnabled,e._grid.smoothing=!1,e._grid.alpha=.1,e._grid.scaleX=e._grid.scaleY=e._gridScale,e._grid.fillMode=egret.BitmapFillMode.REPEAT,e._grid.bitmapData=new egret.BitmapData(document.getElementById("background")),e.addChild(e._viewStage),e}return __extends(e,t),e.prototype._resizeHandler=function(t){var e=Math.max(this._stageWidth,1),a=Math.max(this._stageHeight,1);this._stageWidth=this.stage.stageWidth,this._stageHeight=this.stage.stageHeight,this._lineH.scaleX=.01*this._stageWidth,this._lineV.scaleY=.01*this._stageHeight;var n=this._grid.bitmapData.width*this._grid.scaleX,i=this._grid.bitmapData.height*this._grid.scaleY;this._grid.width=(this._stageWidth+n)/this._grid.scaleX,this._grid.height=(this._stageHeight+i)/this._grid.scaleY,this._updateBackground(),egret.Tween.get(this._viewStage,{onChange:this._updateBackground,onChangeObj:this}).to({x:this._stageWidth*this._viewStage.x/e,y:this._stageHeight*this._viewStage.y/a},300,egret.Ease.cubicOut)},e.prototype._touchHandler=function(t){switch(t.type){case egret.TouchEvent.TOUCH_BEGIN:this._isDraged=!1,egret.Tween.removeTweens(this);break;case egret.TouchEvent.TOUCH_END:var e=(new Date).getTime();if(e-this._time<300)this.scaleToType(this._scaleType+1),clearTimeout(this._timer);else if(!this._isDraged){if(t.target instanceof dragonBones.EgretArmatureDisplay){var a=t.target.armature;Main.getInstance().model.armature=a}clearTimeout(this._timer),this._timer=setTimeout(function(){Main.getInstance().model.armature&&Main.getInstance().model.nextAnimation()},300)}this._time=e;break;case DragManager.DRAG_MOVE:this._isDraged=!0,this._updateBackground()}},e.prototype._modelEventHandler=function(t){switch(t.type){case ModelEvent[ModelEvent.ArmatureAdd]:var e=t.data;this._armatureContainer.addChild(e.display).touchEnabled=!0;break;case ModelEvent[ModelEvent.ArmatureChange]:this.scaleToType(1);break;case ModelEvent[ModelEvent.ArmatureRemove]:var e=t.data;this._armatureContainer.removeChild(e.display)}},e.prototype._updateBackground=function(){this._lineH.x=-this._viewStage.x,this._lineV.y=-this._viewStage.y;var t=this._grid.bitmapData.width*this._grid.scaleX,e=this._grid.bitmapData.height*this._grid.scaleY;this._grid.x=-Math.ceil(this._viewStage.x/t)*t,this._grid.y=-Math.ceil(this._viewStage.y/e)*e},e.prototype._getFormatScale=function(t){return t<e.MIN_SCALE?t=e.MIN_SCALE:t>e.MAX_SCALE&&(t=e.MAX_SCALE),t},e.prototype.init=function(){var t=this;this._resizeHandler(null),this.scaleToType(1,0),this._viewStage.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this._touchHandler,this),this._viewStage.addEventListener(egret.TouchEvent.TOUCH_END,this._touchHandler,this),this._viewStage.addEventListener(DragManager.DRAG_MOVE,this._touchHandler,this),this.stage.addEventListener(egret.Event.RESIZE,this._resizeHandler,this),DragManager.getInstance().enableDrag(this._viewStage),document.addEventListener("mousewheel",function(e){if(!(e.x<0||e.x>0+t._stageWidth||e.y<0||e.y>0+t._stageHeight)){var a=e.wheelDelta>0?t._getFormatScale(1.2*t.stageScale):t._getFormatScale(.8*t.stageScale);t.stageScale!==a&&(t._stageScalePoint.x=e.x-t._viewStage.x,t._stageScalePoint.y=e.y-t._viewStage.y,t._stageScalePoint.x=t._viewStage.x+(t._stageScalePoint.x-t._stageScalePoint.x/t.stageScale*a),t._stageScalePoint.y=t._viewStage.y+(t._stageScalePoint.y-t._stageScalePoint.y/t.stageScale*a),t.scaleTo(a,t._stageScalePoint))}}),Main.getInstance().context.addEventListener(ModelEvent[ModelEvent.ArmatureAdd],this._modelEventHandler,this),Main.getInstance().context.addEventListener(ModelEvent[ModelEvent.ArmatureChange],this._modelEventHandler,this),Main.getInstance().context.addEventListener(ModelEvent[ModelEvent.ArmatureRemove],this._modelEventHandler,this)},e.prototype.scaleTo=function(t,e,a){void 0===a&&(a=500),egret.Tween.removeTweens(this),egret.Tween.removeTweens(this._viewStage),egret.Tween.get(this).to({stageScale:t},a,egret.Ease.cubicOut),e&&egret.Tween.get(this._viewStage,{onChange:this._updateBackground,onChangeObj:this}).to({x:e.x,y:e.y},a,egret.Ease.cubicOut)},e.prototype.scaleToType=function(t,e){void 0===e&&(e=500),this._scaleType=t,2===this._scaleType&&(this._scaleType=0);var a=1,n=Main.getInstance().model.armature;if(n){var i=n.display.getBounds(),r=this._stageWidth/this._stageHeight,o=i.width/i.height;switch(this._scaleType){case 0:break;case 1:a=r>o?this._stageHeight/(i.height+100):this._stageWidth/(i.width+100)}this._stageScalePoint.x=.5*this._stageWidth-(i.x+.5*i.width)*a,this._stageScalePoint.y=.5*this._stageHeight-(i.y+.5*i.height)*a}else this._stageScalePoint.x=.5*this._stageWidth,this._stageScalePoint.y=.5*this._stageHeight;this.scaleTo(a,this._stageScalePoint,e)},e.prototype.updateEgretSize=function(t,e){this.stage.removeEventListener(egret.Event.RESIZE,this._resizeHandler,this);for(var a=document.querySelectorAll(".egret-player"),n=0,i=a.length;i>n;n++){var r=a[n],o=r["egret-player"].player;o.updateStageSize(t,e),this._resizeHandler(null)}},Object.defineProperty(e.prototype,"gridEnabled",{get:function(){return this._gridEnabled},set:function(t){this._gridEnabled!==t&&(this._gridEnabled=t,this._gridEnabled?(this._grid.alpha=.1,this._lineH.visible=!0,this._lineV.visible=!0):(this._grid.alpha=0,this._lineH.visible=!1,this._lineV.visible=!1))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stageScale",{get:function(){return this._stageScale},set:function(t){t=this._getFormatScale(t),this._stageScale=t,this._armatureContainer.scaleX=this._armatureContainer.scaleY=this._stageScale,this._grid.scaleX=this._grid.scaleY=Math.max(this._stageScale*this._gridScale,.2);var e=this._grid.bitmapData.width*this._grid.scaleX,a=this._grid.bitmapData.height*this._grid.scaleY;this._grid.width=(this._stageWidth+e)/this._grid.scaleX,this._grid.height=(this._stageHeight+a)/this._grid.scaleY,this._updateBackground()},enumerable:!0,configurable:!0}),e}(egret.DisplayObjectContainer);DragonBonesView.MAX_SCALE=25,DragonBonesView.MIN_SCALE=.1,__reflect(DragonBonesView.prototype,"DragonBonesView");